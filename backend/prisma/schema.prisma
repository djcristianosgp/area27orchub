// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Seed configuration
model Seed {
  id String @id @default(cuid())
}
// ============ USERS ============
model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  name      String
  role      UserRole   @default(ADMIN)
  companyId String?    @map("company_id")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  company   Company?   @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
  VIEWER
}

// ============ CLIENTS ============
model Client {
  id              String          @id @default(cuid())
  // Dados Básicos
  name            String          // Nome/Razão Social (Obrigatório)
  nickname        String?         // Apelido/Nome Fantasia
  cpfCnpj         String?         @unique @map("cpf_cnpj")
  status          ClientStatus    @default(ACTIVE)
  companyId       String?         @map("companyId")
  
  // Localização
  street          String?         @map("street")
  number          String?         @map("number")
  neighborhood    String?         @map("neighborhood")
  city            String?         @map("city")
  zipCode         String?         @map("zip_code")
  state           String?         @map("state")
  
  // Múltiplos Contatos
  clientEmails    ClientEmail[]   @relation("ClientToEmails")
  clientPhones    ClientPhone[]   @relation("ClientToPhones")
  clientSocialMedia ClientSocialMedia[] @relation("ClientToSocialMedia")
  
  // Observações
  observations    String?
  
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  invoices        Invoice[]
  company         Company?        @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@map("clients")
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

model ClientEmail {
  id        String   @id @default(cuid())
  email     String
  clientId  String   @map("client_id")
  primary   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  client    Client   @relation("ClientToEmails", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, email])
  @@map("client_emails")
}

model ClientPhone {
  id          String   @id @default(cuid())
  phone       String
  clientId    String   @map("client_id")
  hasWhatsapp Boolean  @default(false) @map("has_whatsapp")
  primary     Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  client      Client   @relation("ClientToPhones", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, phone])
  @@map("client_phones")
}

model ClientSocialMedia {
  id        String   @id @default(cuid())
  platform  String   // Instagram, Facebook, LinkedIn, etc
  url       String
  clientId  String   @map("client_id")
  createdAt DateTime @default(now()) @map("created_at")

  client    Client   @relation("ClientToSocialMedia", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, platform])
  @@map("client_social_media")
}

// ============ CATEGORIES ============
model Category {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  products    Product[]

  @@map("categories")
}

// ============ BRANDS ============
model Brand {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  products    Product[]

  @@map("brands")
}

// ============ GROUPS ============
model Group {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  products    Product[]

  @@map("groups")
}

// ============ PRODUCTS ============
model Product {
  id          String     @id @default(cuid())
  name        String
  description String?
  categoryId  String
  brandId     String
  groupId     String
  image       String?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  category    Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  brand       Brand      @relation(fields: [brandId], references: [id], onDelete: Cascade)
  group       Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  variations  ProductVariation[]
  invoiceItems InvoiceItem[]

  @@map("products")
}

model ProductVariation {
  id              String     @id @default(cuid())
  name            String
  price           Decimal    @db.Decimal(10, 2)
  affiliateLink   String?
  observation     String?
  productId       String
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  product         Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_variations")
}

// ============ SERVICES ============
model Service {
  id          String     @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  variations  ServiceVariation[]
  invoiceItems InvoiceItem[]

  @@map("services")
}

model ServiceVariation {
  id          String     @id @default(cuid())
  name        String
  price       Decimal    @db.Decimal(10, 2)
  observation String?
  serviceId   String
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  service     Service    @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("service_variations")
}

// ============ INVOICES ============
model Invoice {
  id                  String          @id @default(cuid())
  code                String          @unique          // Código único do orçamento
  clientId            String          @map("clientId")
  status              InvoiceStatus   @default(DRAFT)
  totalAmount         Decimal         @db.Decimal(12, 2) @default(0)
  // Página pública
  publicUrl           String?         @unique @map("publicUrl")
  // Resposta do cliente
  clientResponseStatus String?        @map("responseStatus")
  clientResponseDate   DateTime?      @map("responseDate")
  
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  client              Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  items               InvoiceItem[]
  groups              InvoiceGroup[]
  paymentConditions   PaymentCondition[]

  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT          // Rascunho
  READY          // Pronto
  EXPIRED        // Vencido
  APPROVED       // Aprovado
  REFUSED        // Recusado
  COMPLETED      // Concluído
  INVOICED       // Faturado
  ABANDONED      // Abandonado
  DESISTED       // Desistido
}

model InvoiceGroup {
  id        String     @id @default(cuid())
  name      String
  type      GroupType  // PRODUCT or SERVICE
  invoiceId String
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  invoice   Invoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  items     InvoiceItem[]

  @@map("invoice_groups")
}

enum GroupType {
  PRODUCT
  SERVICE
}

model InvoiceItem {
  id                  String     @id @default(cuid())
  quantity            Int        @default(1)
  unitPrice           Decimal    @db.Decimal(10, 2)
  totalPrice          Decimal    @db.Decimal(12, 2)
  
  // Campos customizáveis (exclusivos deste orçamento)
  customName          String?    // Nome customizado
  customDescription   String?    // Descrição customizada
  customPrice         Decimal?   @db.Decimal(10, 2) // Preço customizado
  
  invoiceId           String     @map("invoiceId")
  invoiceGroupId      String     @map("invoiceGroupId")
  productId           String?    @map("productId")
  serviceId           String?    @map("serviceId")
  productVariationId  String?    @map("productVariationId")
  serviceVariationId  String?    @map("serviceVariationId")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  invoice             Invoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceGroup        InvoiceGroup @relation(fields: [invoiceGroupId], references: [id], onDelete: Cascade)
  product             Product?   @relation(fields: [productId], references: [id], onDelete: SetNull)
  service             Service?   @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  
  @@map("invoice_items")
}

// ============ PAYMENT CONDITIONS ============
model PaymentCondition {
  id              String     @id @default(cuid())
  invoiceId       String     @map("invoice_id")
  type            PaymentType // CASH, INSTALLMENTS, DEBIT_CARD, CREDIT_CARD, PIX, BOLETO
  description     String?
  numberOfInstallments Int?  // Para parcelado
  interestRate    Decimal    @db.Decimal(5, 2) @default(0)  // Taxa de juros
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  invoice         Invoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("payment_conditions")
}

enum PaymentType {
  CASH           // À vista
  INSTALLMENTS   // A prazo
  DEBIT_CARD     // Cartão de débito
  CREDIT_CARD    // Cartão de crédito
  PIX            // Pix
  BOLETO         // Boleto
}

// ============ COUPONS ============
model Coupon {
  id            String     @id @default(cuid())
  title         String
  description   String?
  platform      String     // Amazon, Mercado Livre, AliExpress, etc
  code          String     @unique
  affiliateLink String
  validUntil    DateTime
  active        Boolean    @default(true)
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  @@map("coupons")
}

// ============ COMPANY ============
model Company {
  id           String          @id @default(cuid())
  name         String          // Razão Social (Obrigatório)
  nickname     String?         // Nome Fantasia
  cpfCnpj      String?         @unique @map("cpf_cnpj")
  street       String?
  number       String?
  neighborhood String?
  city         String?
  zipCode      String?         @map("zip_code")
  state        String?
  observations String?
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  emails       CompanyEmail[]
  phones       CompanyPhone[]
  socials      CompanySocial[]
  pixKeys      CompanyPixKey[]

  users        User[]
  clients      Client[]

  @@map("companies")
}

model CompanyEmail {
  id         String   @id @default(cuid())
  email      String
  primary    Boolean  @default(false)
  companyId  String   @map("companyId")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, email])
  @@map("company_emails")
}

model CompanyPhone {
  id         String   @id @default(cuid())
  phone      String
  hasWhatsapp Boolean @default(false)
  primary    Boolean  @default(false)
  companyId  String   @map("companyId")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, phone])
  @@map("company_phones")
}

model CompanySocial {
  id         String   @id @default(cuid())
  platform   String
  url        String
  companyId  String   @map("companyId")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, platform])
  @@map("company_socials")
}

model CompanyPixKey {
  id         String   @id @default(cuid())
  key        String
  type       String?
  companyId  String   @map("companyId")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, key])
  @@map("company_pix_keys")
}
